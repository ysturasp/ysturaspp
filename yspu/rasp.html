<!DOCTYPE html>
<html lang="ru" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0F172A" />
  <meta name="apple-mobile-web-app-title" content="ystuRASP" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Актуальное расписание занятий ЯГПУ. Найдите свои занятия по группе" />
  <meta name="keywords"
    content="ystuRASP, ягпу им ушинского, расписание ЯГПУ, ЯГПУ, ягпу расписание занятий, ФСУ, факультет социального управления, расписание, ягпу расписание по группам, расписание занятий, расписание студентов" />
  <meta name="geo.region" content="RU-YAR" />
  <meta property="og:description"
    content="Актуальное расписание занятий студентов ЯГПУ. Узнайте расписание лекций и семинаров по всем институтам и группам." />
  <link rel="icon" href="../images/cat.png" type="image/png">
  <link rel="apple-touch-icon" href="../images/favicon.png" />
  <title>ystuRASP. Расписание занятий ЯГПУ</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="../preloader.js" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="../config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap");

    ::selection {
      background-color: #ffc935;
      color: #000000;
      border-radius: 5px;
      padding: 1.2em;
    }

    img::selection {
      background-color: transparent;
      color: inherit;
    }

    @import url("https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap");

    body {
      font-family: "Inter", sans-serif;
    }

    .dark .bg-slate-800 {
      background-color: #1e293b;
    }

    .dark .text-white {
      color: #ffffff;
    }

    .dark .text-slate-400 {
      color: #94a3b8;
    }

    .bg-slate-900 {
      background-color: #111827;
    }

    .hover\:bg-blue-700:hover {
      background-color: #1e40af;
    }

    .transition-all {
      transition: all 0.3s ease;
    }

    .icon-square {
      width: 70px;
      height: 70px;
      margin-right: 0 auto;
      vertical-align: middle;
    }

    .loading-indicator {
      width: 320px;
      height: 320px;
      background: url("https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_6631fab38bcdab100e7c214e_6634a992a228f13b4de1505c/orig") no-repeat center center;
      background-size: cover;
      border-radius: 50%;
    }

    .loading-text {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #1e293bc4;
      border-radius: 5px;
      color: #fff;
      font-size: 1.2em;
      text-align: center;
    }

    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 50;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 34px;
      height: 20px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196f3;
    }

    input:checked+.slider:before {
      transform: translateX(14px);
    }

    .slider.round {
      border-radius: 34px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    #warningModal {
      z-index: 10000;
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      background-color: rgba(0, 0, 0, 0.5);
    }

    #tooltip2 {
      top: -253px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    #tooltip2.show {
      z-index: 10000;
      opacity: 1;
      visibility: visible;
    }

    .tooltip-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      z-index: 9999;
      display: none;
      pointer-events: none;
    }

    .tooltip-overlay.show {
      display: block;
    }

    @keyframes fadeInScale {
      0% {
        transform: translateY(-30%) scale(0.8);
        opacity: 0;
      }

      100% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    @keyframes fadeOutScale {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-30%) scale(0.8);
        opacity: 0;
      }
    }

    #mobile-menu.show {
      display: block;
      animation: fadeInScale 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
    }

    #mobile-menu.hide {
      animation: fadeOutScale 0.2s ease-in forwards;
    }

    .notification {
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
    }

    .notification.show {
      opacity: 1;
    }

    .notification.hide {
      opacity: 0;
    }

    #mobile-menu.show {
      display: block;
      animation: fadeInScale 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
    }

    #mobile-menu.hide {
      animation: fadeOutScale 0.2s ease-in forwards;
    }

    @keyframes animIn {
      0% {
        opacity: 0;
      }

      100% {
        opacity: 1;
      }
    }

    @keyframes animInScale {
      0% {
        opacity: 0;
        transform: scale(0.8);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes animOut {
      0% {
        opacity: 1;
      }

      100% {
        opacity: 0;
      }
    }

    @keyframes animOutScale {
      0% {
        opacity: 1;
        transform: scale(1);
      }

      100% {
        opacity: 0;
        transform: scale(0.8);
      }
    }

    .modal-background-hide {
      animation: animOut 0.3s ease forwards;
      opacity: 0;
    }

    .modal-content-hide {
      animation: animOutScale 0.4s ease-out forwards;
    }

    #infoModal {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    .modal-background-show {
      animation: animIn 0.3s ease forwards;
      opacity: 1;
    }

    .modal-content-show {
      animation: animInScale 0.4s ease-out forwards;
    }

    .hover-bold {
      transition: all 0.4s ease-in-out;
    }

    .hover-bold:hover {
      font-family: "Pixelify Sans", sans-serif;
      font-size: 20px;
      font-weight: bold;
    }

    .online-users-counter {
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(4px);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: help;
      position: relative;
    }

    .online-users-counter:hover::after {
      content: "Количество пользователей на сайте прямо сейчас";
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      border: 1px solid rgba(59, 130, 246, 0.5);
      z-index: 50;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .online-users-counter:hover::before {
      content: "";
      position: absolute;
      top: calc(100% + 3px);
      left: 50%;
      transform: translateX(-50%);
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 5px solid rgba(59, 130, 246, 0.5);
    }

    @media (max-width: 768px) {
      .online-users-counter:hover::after {
        bottom: auto;
        top: calc(100% + 8px);
      }

      .online-users-counter:hover::before {
        bottom: auto;
        top: calc(100% + 3px);
        border-top: none;
        border-bottom: 5px solid rgba(59, 130, 246, 0.5);
      }
    }

    .online-users-counter.mobile {
      display: none;
      margin: 10px auto;
      margin-bottom: -8px;
      width: fit-content;
    }

    @media (max-width: 768px) {
      .online-users-counter.desktop {
        display: none;
      }

      .online-users-counter.mobile {
        display: flex;
      }
    }

    .online-indicator {
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .online-users-counter[data-groups]::after {
      content: attr(data-groups);
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: pre;
      text-align: center;
      border: 1px solid rgba(59, 130, 246, 0.5);
      z-index: 50;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      display: none;
    }

    .online-users-counter[data-groups]:hover::after {
      display: block;
    }

    @media (max-width: 768px) {
      .online-users-counter[data-groups]::after {
        bottom: auto;
        top: calc(100% + 8px);
      }
    }

    .pwa-section {
      display: block;
    }

    @media (display-mode: standalone) {
      .pwa-section {
        display: none;
      }
    }
  </style>
</head>

<body class="bg-slate-900 text-gray-300 antialiased">
  <header class="container mx-auto sticky top-4 px-3 md:px-0 z-50">
    <div style="background-color: #1e293bad; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);"
      class="rounded-lg px-3 py-2 md:px-6 md:py-4 ring-1 ring-slate-900/5 shadow-xl flex justify-between items-center transition-all">
      <nav class="hidden lg:flex gap-x-4">
        <div class="flex items-center gap-x-4 border-r border-slate-700 pr-4">
          <a href="/rasp.html" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
            ЯГТУ
          </a>
          <a href="/yspu/rasp.html"
            class="text-blue-500 font-semibold text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
            ЯГПУ
          </a>
        </div>
        <a href="/"
          class="text-blue-500 font-semibold text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <img src="../images/cat.png" class="w-10 h-10 mr-2" />
          <span class="text-sm md:text-base">ystuRASP Главная</span>
        </a>
        <a href="/stat" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <span class="text-sm md:text-base"> </span>
          Статистика
        </a>
        <a href="/rasp" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <span class="text-sm md:text-base"> </span>
          Расписание
        </a>
        <a href="/campus" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <span class="text-sm md:text-base"> </span>
          Кампус
        </a>
        <a href="/data" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <span class="text-sm md:text-base"> </span>
          Данные
        </a>
        <a href="/about" class="text-sm md:text-base hover:text-blue-400 transition-all flex items-center">
          <span class="text-sm md:text-base"> </span>
          О нас
        </a>
      </nav>
      <div class="relative lg:hidden">
        <button id="mobile-menu-btn" class="p-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-all">
          <svg class="w-6 h-6 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>
      <div class="flex gap-x-2">
        <div class="online-users-counter desktop">
          <div class="online-indicator"></div>
          <span id="online-count-desktop">1</span> онлайн
        </div>
        <a href="https://boosty.to/ysturasp.me/donate"
          class="p-1 md:p-2 bg-blue-700 text-white rounded-lg text-sm md:text-sm hover:bg-blue-600 transition-all border-2 border-blue-700 hover:border-blue-600">
          Поддержать проект <span class="text-xl align-middle">💸</span>
        </a>
      </div>
    </div>
    <div class="online-users-counter mobile">
      <div class="online-indicator"></div>
      <span id="online-count-mobile">1</span> онлайн
    </div>
    <div id="mobile-menu"
      class="md:hidden bg-slate-800 rounded-lg mt-4 px-3 py-2 md:px-6 md:py-3 ring-1 ring-slate-900/5 shadow-xl absolute top-full left-3 right-3 hidden">
      <div class="flex justify-center gap-4 border-b border-slate-700 pb-2 mb-2">
        <a href="/rasp.html" class="text-gray-400 hover:text-blue-400">ЯГТУ</a>
        <a href="/yspu/rasp.html" class="text-blue-500 font-semibold">ЯГПУ</a>
      </div>
      <a href="/" class="block py-2 text-blue-500 font-semibold text-sm md:text-base">ystuRASP Главная</a>
      <a href="/stat" class="block py-2 hover:text-blue-400 text-sm md:text-base">Статистика</a>
      <a href="/rasp" class="block py-2 hover:text-blue-400 text-sm md:text-base">Расписание</a>
      <a href="/campus" class="block py-2 hover:text-blue-400 text-sm md:text-base">Кампус</a>
      <a href="/data" class="block py-2 hover:text-blue-400 text-sm md:text-base">Данные</a>
      <a href="/about" class="block py-2 hover:text-blue-400 text-sm md:text-base">О нас</a>
    </div>
  </header>

  <main class="container mx-auto mt-5 md:mt-7 px-3 md:px-0">
    <section class="bg-slate-800 rounded-lg sm:p-6 p-4 mt-8">
      <div class="bg-yellow-500 text-black text-center p-4 rounded-lg mb-4 relative">
        <span id="betaBadge"
          class="absolute -top-2 -right-2 transform rotate-12 flex rounded-full bg-indigo-500 uppercase px-2 py-1 text-xs font-bold text-white shadow-lg cursor-pointer hover:bg-indigo-600 transition-colors"
          onclick="console.log('Direct click handler'); document.getElementById('betaExplanationModal').classList.remove('translate-y-full');">Beta</span>
        <div class="flex items-center justify-center gap-2">
          <div class="h-3 w-3 mr-1 rounded-full ring-8 animate-pulse" style="
                background-color: rgb(82, 255, 2);
                --tw-ring-color: #51ff003c;
              "></div>
          <p class="font-semibold mb-1">Расписание актуально</p>
        </div>
        <!-- <div class="h-3 w-3 mr-1 rounded-full ring-8 animate-pulse" 
                        style="background-color: rgb(239, 14, 14); --tw-ring-color: #ff00003c;"></div>
                        <p class="font-semibold">Расписание НЕактуально</p>
                    </div>
                    <p class="mt-2 mb-2">
                        Текущее расписание относится к предыдущему семестру. Актуальное расписание на осенний семестр 2024/2025 учебного года скоро будет добавлено.
                    </p> -->
        <div id="week-info" class="text-14 -tracking-3 text-black leading-inter-trimmed truncate flex-shrink-full">
        </div>
      </div>
      <div class="flex items-center mb-4">
        <h2 id="calendarIcon" class="text-4xl font-semibold text-white">
          📅
        </h2>
        <h2 class="text-2xl md:text-4xl font-semibold text-white ml-2">
          Расписание занятий ФСУ ЯГПУ
        </h2>
      </div>

      <div class="bg-green-100 rounded-lg py-2 px-6 mb-4 text-base text-green-700 hide-in-tg pwa-section" role="alert">
        А в
        <a href="https://t.me/ysturasp_yspu_bot/ysturasp_yspu" class="font-bold">мини-приложение в Telegram </a>удобнее
        -
        <a href="https://t.me/ysturasp_yspu_bot/ysturasp_yspu" class="font-bold">попробовать!</a>
      </div>

      <form id="schedule-form" class="grid grid-cols-1 gap-4">
        <div>
          <label for="institute-select" class="block text-white mb-2">Выберите профиль:</label>
          <select id="institute-select" class="w-full p-2 bg-slate-900 text-white rounded-lg">
            <option value="">Выберите профиль</option>
          </select>
        </div>
        <div>
          <label for="group-select" class="block text-white mb-2">Выберите группу:</label>
          <select id="group-select" class="w-full p-2 bg-slate-900 text-white rounded-lg">
            <option value="">Сначала выберите профиль</option>
          </select>
        </div>
        <button type="submit" class="p-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-all">
          Показать расписание
        </button>
      </form>
      <div class="flex justify-between items-center mt-4 w-full">
        <button id="copy-link-button"
          class="p-2 border-2 border-blue-700 text-white rounded-lg hover:border-indigo-800 hover:text-indigo-800 transition-all flex items-center justify-center">
          <span class="text-3xl md:text-xl align-middle">🔗</span>
          <span class="ml-2 text-sm align-middle hidden md:inline">Скопировать ссылку на расписание</span>
        </button>
      </div>
      <div id="schedule" class="grid grid-cols-1 gap-4 mt-4"></div>
      <div class="border-2 border-red-600 text-white p-2 rounded-lg mt-4 mb-2 bg-transparent">
        <p class="text-md text-center">
          Если данные не отображаются, возможно, проблемы API и в данный
          момент она перегружена пользователями. Попробуйте обновить страницу
          позже.
          <a href="https://stats.uptimerobot.com/COz2FUGsub" class="text-blue-500 hover:text-blue-300"
            target="_blank">Нажми, чтобы узнать о состоянии сервисов сайта</a>
          или
          <a href="/support" class="text-blue-500 hover:text-blue-300">напиши в нашу поддержку</a>.
        </p>
      </div>
    </section>

    <section id="hidden-subjects-section" class="bg-slate-800 rounded-lg p-6 mt-8 hidden">
      <h2 class="text-2xl md:text-4xl font-semibold text-white mb-4">
        Скрытые предметы
      </h2>
      <div id="hidden-subjects" class="grid grid-cols-1 gap-4"></div>
    </section>

    <section id="subject-statistics" class="bg-slate-800 rounded-lg p-6 mt-8 hidden">
      <h2 class="text-2xl md:text-4xl font-semibold text-white mb-4">
        Учебная нагрузка для выбранной группы
      </h2>
      <div id="statistics-container" class="grid grid-cols-1 gap-4"></div>
    </section>

    <section id="features-section" class="pwa-section hide-in-tg">
      <h2 class="text-3xl md:text-4xl font-semibold text-white mt-6">
        😎 Поясняем за наши топовые фичи
      </h2>
      <div class="flex flex-wrap justify-center gap-6 p-6">
        <div class="card bg-slate-800 p-6 rounded-lg text-center max-w-md w-full">
          <div class="bg-amber-500 h-27 w-54 mx-auto mb-4 rounded-full">
            <a class="font-extrabold text-gray-200" href="../installapp"><img src="../../images/icon_phone.png"
                alt="" /></a>
          </div>
          <h3 class="text-xl font-bold text-white mb-2">
            Приложение на телефон
          </h3>
          <p class="text-slate-400 mb-4">
            <a class="font-extrabold text-gray-200" href="/installapp">Установите приложение</a>
            для удобного и быстрого доступа к расписанию
          </p>
          <div class="flex flex-wrap justify-center gap-2 mb-4">
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">Расписание</span>
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">New</span>
          </div>
        </div>
        <div class="card bg-slate-800 p-6 rounded-lg text-center max-w-md w-full">
          <div class="bg-amber-500 h-27 w-54 mx-auto mb-4 rounded-full">
            <img src="../images/rasp1.png" alt="" />
          </div>
          <h3 class="text-xl font-bold text-white mb-2">Удобный просмотр</h3>
          <p class="text-slate-400 mb-4">
            Крутой стильный современный дизайн, адаптированный под любое
            устройство, удобно будет всем!
          </p>
          <div class="flex flex-wrap justify-center gap-2 mb-4">
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">Расписание</span>
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">New</span>
          </div>
        </div>
        <div class="card bg-slate-800 p-6 rounded-lg text-center max-w-md w-full">
          <div class="bg-amber-500 h-27 w-54 mx-auto mb-4 rounded-full">
            <img src="../images/rasp2.png" alt="" />
          </div>
          <h3 class="text-xl font-bold text-white mb-2">
            Настройка под себя
          </h3>
          <p class="text-slate-400 mb-4">
            Скрывайте ненужные предметы, создавайте свое идеальное расписание!
          </p>
          <div class="flex flex-wrap justify-center gap-2 mb-4">
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">Расписание</span>
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">New</span>
          </div>
        </div>
        <div class="card bg-slate-800 p-6 rounded-lg text-center max-w-md w-full">
          <div class="bg-amber-500 h-27 w-54 mx-auto mb-4 rounded-full">
            <img style="margin: 0 auto; padding-left: 20px" src="../images/rasp4.png" alt="" width="80%" />
          </div>
          <h3 class="text-xl font-bold text-white mb-2">
            Полная конфиденциальность
          </h3>
          <p class="text-slate-400 mb-4">
            Вам не требуется регистрироваться у нас на сайте для скрытия
            предметов из расписания, эту информацию мы храним локально на
            Вашем устройстве. Доступ к ней имеете только Вы!
          </p>
          <div class="flex flex-wrap justify-center gap-2 mb-4">
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">Расписание</span>
            <span class="bg-gray-700 text-xs text-white py-1 px-2 rounded">New</span>
          </div>
        </div>
      </div>
    </section>

    <section class="bg-slate-800 rounded-lg p-6 mt-8">
      <h2 class="text-xl text-center font-semibold text-white mb-2">
        <a href="https://github.com/ysturasp/parser-schedule-yspu">
          parser-schedule-yspu
          <img class="h-6 ml-1 inline" src="../images/github.png" alt="GitHub" />
        </a>
      </h2>
      <p class="text-sm text-center text-slate-400">
        Вот исходный код
        <a class="font-bold text-white" href="https://github.com/ysturasp/parser-schedule-yspu">парсера</a>
        для получения расписания факультета
      </p>
    </section>
  </main>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-indicator"></div>
      <div class="loading-text">Загрузка, ожидайте...</div>
    </div>
  </div>

  <div id="warningModal" class="fixed inset-0 hidden">
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-gray-600 rounded-lg p-4 ml-4 mr-4 max-w-md mx-auto text-center">
        <h3 class="text-2xl leading-6 font-medium text-white">
          Это же просто эмодзи 🙃
        </h3>
        <div class="mt-4">
          <p id="warningMessage" class="text-slate-400">
            Пожалуйста, выберите неделю в соответствующем поле
          </p>
        </div>
        <div class="mt-6">
          <button id="closeModalBtn"
            class="inline-flex justify-center px-4 py-2 text-sm font-medium text-blue-700 bg-blue-200 rounded-lg hover:bg-blue-300">
            Закрыть
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden">
    <div id="modalContent" class="bg-gray-600 rounded-lg p-4 ml-4 mr-4 max-w-md mx-auto text-center relative">
      <h2 class="text-xl font-bold mb-2 mr-7">
        🥳У нас появилось мини приложение в телеграмм!
      </h2>
      <p class="text-white mb-4">
        Теперь расписание доступно прямо в вашем любимом мессенджере!
        Закрепляйте в своей беседе группы🙃
      </p>
      <p class="text-red-500 mb-4">
        P.S. Подключитесь к VPN если данное окошко не закрывается и расписание
        не грузится
      </p>
      <button id="tryButton">
        <img id="telegramImage" src="../images/tg webapp.jpg" alt="Telegram" style="height: 130px"
          class="rounded-lg mx-auto mb-4" />
      </button>
      <button id="closeButton"
        class="absolute top-4 right-4 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition">
        <span class="text-lg font-bold">✖️</span>
      </button>
    </div>
  </div>

  <footer class="bg-slate-800 py-6 mt-12 mb-12">
    <div class="container mx-auto px-4">
      <div class="flex flex-wrap justify-between items-center">
        <div class="w-full md:w-1/3 text-center md:text-left">
          <h2 class="text-white text-lg font-bold">ystuRASP</h2>
          <p class="text-slate-400 mt-2">Экосистема для студентов</p>
        </div>
        <div class="w-full md:w-1/3 text-center mt-4 md:mt-0">
          <nav class="flex justify-center gap-4">
            <a href="https://t.me/ysturasp" class="text-slate-400 hover:text-white transition-all">
              <div class="w-14 h-14 bg-white rounded p-1">
                <img src="https://cdn-icons-png.flaticon.com/512/2111/2111646.png" alt="Telegram"
                  class="mx-auto my-1 w-10 h-10">
              </div>
            </a>
            <a href="https://boosty.to/ysturasp.me" class="text-slate-400 hover:text-white transition-all">
              <div class="w-14 h-14 bg-white rounded p-1">
                <img src="https://boosty.to/favicon.ico" alt="Boosty" class="mx-auto my-1 w-10 h-10">
              </div>
            </a>
            <a href="https://github.com/ysturasp" class="text-slate-400 hover:text-white transition-all">
              <div class="w-14 h-14 bg-white rounded p-1">
                <img src="../images/github-mark.png" alt="GitHub" class="mx-auto my-1 w-10 h-10">
              </div>
            </a>
          </nav>
        </div>
        <div class="w-full md:w-1/3 text-center md:text-right mt-4 md:mt-0">
          <p class="text-slate-400">© 2024 Made with ❤️ by ystuRASP</p>
          <a href="/changelog"
            class="inline-flex items-center mt-2 text-blue-400 hover:text-blue-300 transition-all group">
            <span class="mr-2">История изменений</span>
            <svg class="w-5 h-5 transform group-hover:translate-x-1 transition-transform" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
            </svg>
          </a>
        </div>
      </div>
    </div>
  </footer>

  <div class="fixed bottom-0 left-0 right-0 bg-slate-800 shadow-lg z-50">
    <div class="flex justify-around p-1 md:p-2 mb-4 md:mb-0">
      <a href="/yspu/rasp" class="flex flex-col items-center text-white hover:text-blue-400 transition" style="background: radial-gradient(circle, rgb(17, 51, 107) 5%, rgb(7, 24, 39, 0) 70%);">
        <span class="text-2xl">👨‍💻</span>
        <span class="text-sm">Студенты</span>
      </a>
      <a href="/yspu/raspprep" class="flex flex-col items-center text-white hover:text-blue-400 transition">
        <span class="text-2xl">👨‍🏫</span>
        <span class="text-sm">Преподаватели</span>
      </a>
      <a href="/yspu/raspaudience" class="flex flex-col items-center text-white hover:text-blue-400 transition">
        <span class="text-2xl">🏛️</span>
        <span class="text-sm">Аудитории</span>
      </a>
    </div>
  </div>

  <script src="../linear.js"></script>

  <div id="betaExplanationModal"
    class="fixed inset-x-0 -bottom-1 z-50 transform translate-y-full transition-transform duration-300 ease-in-out">
    <div class="bg-slate-900 rounded-t-2xl p-6 max-w-lg mx-3 md:mx-auto shadow-xl ring-1">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-white">Что такое Beta?</h3>
        <button id="closeBetaExplanation" class="text-gray-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="text-gray-300">
        <p class="mb-4">Это бета-версия расписания ЯГПУ. Мы разработали экосистему для ЯГТУ, настало время расширяться,
          на одном из факультетов ЯГПУ <a href="https://vk.com/ssovetfsuipp"
            class="text-blue-500 hover:text-blue-600">(Факультет Социального Управления)</a> теперь можно смотреть
          расписание у нас в удобном виде</p>
        <p class="mb-4">Больше никакой путаницы с таблицами — только чёткое и понятное расписание. А также широкий выбор
          где можно посмотреть: браузер, <a class="font-extrabold text-gray-200" href="/installapp">web-приложение на
            iPhone</a>, или <a class="font-extrabold text-gray-200"
            href="https://t.me/ysturasp_yspu_bot/ysturasp_yspu">мини-приложение в телеграме</a></p>
        <p>На начальном этапе могут быть некоторые косяки. Если у вас есть предложения по улучшению или вы нашли ошибку,
          пожалуйста, сообщите об этом <a href="https://t.me/ysturasp_bot"
            class="text-blue-500 hover:text-blue-600">нам</a></p>
      </div>
    </div>
  </div>

  <div id="viewModeExplanationModal"
    class="fixed inset-x-0 -bottom-1 z-50 transform translate-y-full transition-transform duration-300 ease-in-out">
    <div class="bg-slate-900 rounded-t-2xl p-6 max-w-lg mx-3 md:mx-auto shadow-xl ring-1">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-white">Режимы просмотра расписания</h3>
        <button id="closeViewModeExplanation" class="text-gray-400 hover:text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="text-gray-300">
        <div class="mb-4 bg-gray-800 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-blue-400 mb-2">Общее расписание</h4>
          <p>Показывает общее расписание с учетом всех предметов, независимо от дат их начала и окончания. Полезно для
            общего ознакомления со структурой занятий на семестр.</p>
        </div>
        <div class="mb-4 bg-gray-800 p-4 rounded-lg">
          <h4 class="text-lg font-semibold text-blue-400 mb-2">Актуальное по дате</h4>
          <p>Показывает только те предметы, которые проводятся в текущую дату с учетом периодов и условий. Например,
            если для предмета указан период с 10.02.2025 по 10.03.2025, он будет отображаться только в этом диапазоне
            дат.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    function triggerHapticFeedback(type, style) {
        if (window.Telegram?.WebApp) {
            if (type === 'impact') {
                window.Telegram.WebApp.HapticFeedback.impactOccurred(style);
            } else if (type === 'notification') {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred(style);
            } else if (type === 'selection') {
                window.Telegram.WebApp.HapticFeedback.selectionChanged();
            }
        }
    }

    async function waitForTelegramWebApp() {
        return new Promise((resolve) => {
            if (window.Telegram?.WebApp) {
                resolve(window.Telegram.WebApp);
            } else {
                const script = document.createElement('script');
                script.src = 'https://telegram.org/js/telegram-web-app.js';
                script.onload = () => {
                    if (window.Telegram?.WebApp) {
                        resolve(window.Telegram.WebApp);
                    }
                };
                document.head.appendChild(script);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
        window.addEventListener('pageshow', async (event) => {
            if (event.persisted || document.referrer.includes('t.me')) {
                await waitForTelegramWebApp();
                triggerHapticFeedback('impact', 'medium');
            }
        });
        
        await waitForTelegramWebApp();

        const instituteSelect = document.getElementById("institute-select");
        const groupSelect = document.getElementById("group-select");
        const lastInstitut = localStorage.getItem("lastYspuInstitut");
        const lastGroup = localStorage.getItem("lastYspuGroup");
        const mobileMenuButton = document.getElementById("mobile-menu-btn");
        const mobileMenu = document.getElementById("mobile-menu");

        const betaBadge = document.getElementById("betaBadge");
        const betaExplanationModal = document.getElementById("betaExplanationModal");
        const closeBetaExplanationBtn = document.getElementById("closeBetaExplanation");
        const viewModeExplanationModal = document.getElementById("viewModeExplanationModal");
        const closeViewModeExplanationBtn = document.getElementById("closeViewModeExplanation");
        let isBetaModalOpen = false;
        let isViewModeModalOpen = false;

        if (window.location.hash.includes('tgWebAppData')) {
          document.querySelectorAll('.hide-in-tg').forEach(el => el.style.display = 'none');

          document.querySelectorAll('.show-in-tg').forEach(el => {
            if (window.getComputedStyle(el).display === 'flex' || el.classList.contains('flex')) {
              el.style.display = 'flex';
            } else {
              el.style.display = 'block';
            }
          });
        } else {
          document.querySelectorAll('.show-in-tg').forEach(el => el.style.display = 'none');
        }

        console.log('Beta elements:', { betaBadge, betaExplanationModal, closeBetaExplanationBtn });

        function openBetaExplanation() {
          console.log('Opening beta explanation');
          betaExplanationModal.classList.remove("translate-y-full");
          isBetaModalOpen = true;
          document.body.style.overflow = "hidden";
        }

        function closeBetaExplanation() {
          console.log('Closing beta explanation');
          betaExplanationModal.classList.add("translate-y-full");
          isBetaModalOpen = false;
          document.body.style.overflow = "";
          localStorage.setItem('betaModalShown', 'true');
        }

        function openViewModeExplanation() {
          viewModeExplanationModal.classList.remove("translate-y-full");
          isViewModeModalOpen = true;
          document.body.style.overflow = "hidden";
        }

        function closeViewModeExplanation() {
          viewModeExplanationModal.classList.add("translate-y-full");
          isViewModeModalOpen = false;
          document.body.style.overflow = "";
        }

        if (betaBadge) {
          betaBadge.addEventListener("click", (e) => {
            console.log('Beta badge clicked');
            e.stopPropagation();
            openBetaExplanation();
          });
        }

        if (closeBetaExplanationBtn) {
          closeBetaExplanationBtn.addEventListener("click", (e) => {
            console.log('Close button clicked');
            e.stopPropagation();
            closeBetaExplanation();
          });
        }

        if (closeViewModeExplanationBtn) {
          closeViewModeExplanationBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            closeViewModeExplanation();
          });
        }

        document.addEventListener("click", (e) => {
          if (isBetaModalOpen && !betaExplanationModal.contains(e.target) && e.target !== betaBadge) {
            closeBetaExplanation();
          }
          if (isViewModeModalOpen && !viewModeExplanationModal.contains(e.target)) {
            closeViewModeExplanation();
          }
        });

        window.addEventListener('load', () => {
          const betaModalShown = localStorage.getItem('betaModalShown');
          if (!betaModalShown) {
            setTimeout(() => {
              openBetaExplanation();
            }, 1500);
          }
        });

        Date.prototype.getWeek = function () {
          var onejan = new Date(this.getFullYear(), 0, 1);
          var today = new Date(this.getFullYear(), this.getMonth(), this.getDate());
          var dayOfYear = ((today - onejan + 86400000) / 86400000);
          return Math.ceil(dayOfYear / 7);
        };

        const lastWeek = localStorage.getItem('lastYspuWeek') || new Date().getWeek();

        let directionsData = [];

        try {
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbz3GHGEuJnFrSat8dsP3A34PC5QO8FfFlTxPHCxKb83Tb5J2-FmcDVz0BRMcIH7SeAh/exec?action=directions"
          );
          directionsData = await response.json();

          instituteSelect.innerHTML = '<option value="">Выберите направление</option>';
          directionsData.forEach((direction) => {
            instituteSelect.innerHTML += `<option value="${direction.id}">${direction.name}</option>`;
          });

          const urlParams = new URLSearchParams(window.location.search);
          const instituteParam = urlParams.get("institute");
          const groupParam = urlParams.get("group");

          if (instituteParam) {
            const selectedDirection = directionsData.find(dir => dir.id === instituteParam);
            if (selectedDirection) {
              instituteSelect.value = instituteParam;
              updateGroups(instituteParam);

              if (groupParam) {
                groupSelect.value = groupParam;
                setTimeout(() => {
                  document.querySelector('button[type="submit"]').click();
                }, 100);
              }
            }
          } else if (lastInstitut) {
            const selectedDirection = directionsData.find(dir => dir.id === lastInstitut);
            if (selectedDirection) {
              instituteSelect.value = lastInstitut;
              updateGroups(lastInstitut);

              if (lastGroup) {
                groupSelect.value = lastGroup;
                setTimeout(() => {
                  document.querySelector('button[type="submit"]').click();
                }, 100);
              }
            }
          }

          instituteSelect.addEventListener("change", () => {
            const selectedDirection = instituteSelect.value;
            if (selectedDirection) {
              updateGroups(selectedDirection);
              localStorage.setItem("lastYspuInstitut", selectedDirection);
            }
          });

          function updateGroups(directionId) {
            const selectedDirection = directionsData.find(dir => dir.id === directionId);
            if (selectedDirection) {
              groupSelect.innerHTML = '<option value="">Выберите группу</option>';
              const courses = selectedDirection.courses;

              Object.entries(courses).forEach(([key, course]) => {
                groupSelect.innerHTML += `<option value="${key}">${course.name}</option>`;
              });

              if (lastGroup) {
                groupSelect.value = lastGroup;
              }
            }
          }

          document.getElementById("schedule-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            const directionId = instituteSelect.value;
            const course = groupSelect.value;

            if (!directionId || !course) {
              showCustomNotification("Пожалуйста, выберите направление и группу.", "info");
              return;
            }

            localStorage.setItem("lastYspuInstitut", directionId);
            localStorage.setItem("lastYspuGroup", course);

            const scheduleContainer = document.getElementById("schedule");
            scheduleContainer.innerHTML = "";
            const loadingOverlay = document.getElementById("loadingOverlay");
            loadingOverlay.style.display = "flex";

            try {
              const response = await fetch(
                `https://script.google.com/macros/s/AKfycbz3GHGEuJnFrSat8dsP3A34PC5QO8FfFlTxPHCxKb83Tb5J2-FmcDVz0BRMcIH7SeAh/exec?action=schedule&id=${directionId}`
              );
              const data = await response.json();

              displaySchedule(data, course);
              loadingOverlay.style.display = "none";
            } catch (error) {
              console.error("Ошибка при получении расписания:", error);
              scheduleContainer.innerHTML = `<p class="text-red-500">Ошибка при получении расписания: ${error.message}</p>`;
              loadingOverlay.style.display = "none";
            }
          });


        } catch (error) {
          console.error("Ошибка при получении направлений:", error);
          instituteSelect.innerHTML =
            '<option value="">Ошибка при получении направлений</option>';
        }

        function formatDate(isoDate) {
          const date = new Date(isoDate);
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          return `${day}.${month}.${year}`;
        }

        function getDayName(dayNumber) {
          const shortDays = [
            "Пн",
            "Вт",
            "Ср",
            "Чт",
            "Пт",
            "Сб",
            "Вс"
          ];
          return shortDays[dayNumber];
        }

        mobileMenuButton.addEventListener("click", function () {
          if (
            mobileMenu.classList.contains("hide") ||
            mobileMenu.classList.contains("hidden")
          ) {
            mobileMenu.classList.remove("hidden", "hide");
            mobileMenu.classList.add("show");
          } else {
            mobileMenu.classList.remove("show");
            mobileMenu.classList.add("hide");

            mobileMenu.addEventListener(
              "animationend",
              () => {
                if (mobileMenu.classList.contains("hide")) {
                  mobileMenu.classList.add("hidden");
                }
              },
              { once: true }
            );
          }
        });

        document.addEventListener("click", function (event) {
          if (
            !mobileMenu.contains(event.target) &&
            !mobileMenuButton.contains(event.target)
          ) {
            mobileMenu.classList.remove("show");
            mobileMenu.classList.add("hide");

            mobileMenu.addEventListener(
              "animationend",
              () => {
                if (mobileMenu.classList.contains("hide")) {
                  mobileMenu.classList.add("hidden");
                }
              },
              { once: true }
            );
          }
        });

        mobileMenu.querySelectorAll("a").forEach((link) => {
          link.addEventListener("click", function () {
            mobileMenu.classList.remove("show");
            mobileMenu.classList.add("hide");

            mobileMenu.addEventListener(
              "animationend",
              () => {
                if (mobileMenu.classList.contains("hide")) {
                  mobileMenu.classList.add("hidden");
                }
              },
              { once: true }
            );
          });
        });

        function toggleSubjectVisibility(
          group,
          subjectName,
          lessonType,
          teacherName,
          isVisible
        ) {
          let hiddenSubjects =
            JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};
          if (!isVisible) {
            if (!hiddenSubjects[subjectName]) {
              hiddenSubjects[subjectName] = [];
            }
            if (
              !hiddenSubjects[subjectName].some(
                (h) =>
                  h.type === lessonType && h.teacher === (teacherName || "")
              )
            ) {
              hiddenSubjects[subjectName].push({
                type: lessonType,
                teacher: teacherName || "",
              });
            }
            showHideNotification(subjectName, lessonType, teacherName);
          } else {
            if (hiddenSubjects[subjectName]) {
              hiddenSubjects[subjectName] = hiddenSubjects[subjectName].filter(
                (h) =>
                  !(h.type === lessonType && h.teacher === (teacherName || ""))
              );
              if (hiddenSubjects[subjectName].length === 0) {
                delete hiddenSubjects[subjectName];
              }
            }
          }
          localStorage.setItem(
            `hiddenSubjects_${group}`,
            JSON.stringify(hiddenSubjects)
          );
          document
            .getElementById("schedule-form")
            .dispatchEvent(new Event("submit"));
        }

        function showHideNotification(subjectName, lessonType, teacherName) {
          const lessonTypeName = lessonTypes[lessonType] || "Неизвестный тип";

          const notification = document.createElement("div");
          notification.className =
            "fixed bottom-5 right-5 left-5 sm:right-10 sm:left-auto bg-blue-500 text-white py-2 px-4 rounded-lg z-50 notification";
          notification.textContent = `${lessonTypeName} "${subjectName}" ${teacherName ? " с " + teacherName : ""
            } теперь скрыта на протяжении всего семестра. Вы можете просмотреть скрытые предметы под расписанием.`;

          document.body.appendChild(notification);

          notification.addEventListener("touchmove", (e) => {
            e.preventDefault();
          });

          let touchStartX = 0;
          let currentX = 0;
          let moveX = 0;
          let isSwiping = false;

          notification.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
            isSwiping = true;
            notification.style.transition = "";
          });

          notification.addEventListener("touchmove", (e) => {
            if (!isSwiping) return;

            currentX = e.changedTouches[0].screenX;
            moveX = currentX - touchStartX;

            notification.style.transform = `translateX(${moveX}px)`;
          });

          notification.addEventListener("touchend", () => {
            if (!isSwiping) return;

            isSwiping = false;
            if (Math.abs(moveX) > 100) {
              const direction = moveX < 0 ? "-110%" : "110%";
              notification.style.transition = "transform 0.5s ease";
              notification.style.transform = `translateX(${direction})`;

              setTimeout(() => {
                notification.remove();
              }, 500);
            } else {
              notification.style.transition = "transform 0.3s ease";
              notification.style.transform = "translateX(0)";
            }
          });

          notification.addEventListener("click", () => {
            notification.style.transition =
              "transform 0.5s ease, opacity 0.5s ease";
            notification.style.transform = "translateX(100%)";
            notification.style.opacity = "0";

            setTimeout(() => {
              notification.remove();
            }, 500);
          });

          setTimeout(() => {
            notification.classList.add("show");
          }, 10);

          setTimeout(() => {
            notification.classList.remove("show");
            notification.classList.add("hide");

            setTimeout(() => {
              notification.remove();
            }, 500);
          }, 5000);
        }

        function updateHiddenSubjectsSection(group) {
          const hiddenSubjectsSection = document.getElementById(
            "hidden-subjects-section"
          );
          const hiddenSubjectsContainer =
            document.getElementById("hidden-subjects");
          const hiddenSubjects =
            JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};

          const lessonTypes = {
            0: "none",
            2: "Лекция",
            4: "Практика",
            8: "Лабораторная работа",
            1: "Курсовой проект",
            5: "Консультация",
            6: "Лекция + Практика",
            7: "Дифференцированный зачет",
            3: "Экзамен",
            9: "Библиотека",
            10: "Лекция + Лабораторная работа",
            11: "Организационное собрание",
            12: "Не поддерживается",
          };

          hiddenSubjectsContainer.innerHTML = "";
          for (let subject in hiddenSubjects) {
            hiddenSubjects[subject].forEach((item) => {
              const subjectElement = document.createElement("div");
              subjectElement.className =
                "bg-slate-800 p-4 rounded-lg mb-2 flex justify-between items-center";
              subjectElement.innerHTML = `
                              <p class="text-lg font-bold text-white">${subject} (${lessonTypes[item.type]
                }, ${item.teacher})</p>
                              <label class="switch">
                                  <input type="checkbox" onchange="showSubject('${group}', '${subject}', ${item.type
                }, '${item.teacher}')">
                                  <span class="slider round"></span>
                              </label>
                          `;
              hiddenSubjectsContainer.appendChild(subjectElement);
            });
          }

          if (Object.keys(hiddenSubjects).length > 0) {
            hiddenSubjectsSection.classList.remove("hidden");
          } else {
            hiddenSubjectsSection.classList.add("hidden");
          }
        }

        function showSubject(group, subjectName, lessonType, teacherName) {
          let hiddenSubjects =
            JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};
          if (hiddenSubjects[subjectName]) {
            hiddenSubjects[subjectName] = hiddenSubjects[subjectName].filter(
              (h) => !(h.type === lessonType && h.teacher === teacherName)
            );
            if (hiddenSubjects[subjectName].length === 0) {
              delete hiddenSubjects[subjectName];
            }
          }
          localStorage.setItem(
            `hiddenSubjects_${group}`,
            JSON.stringify(hiddenSubjects)
          );
          document
            .getElementById("schedule-form")
            .dispatchEvent(new Event("submit"));
        }

        async function getStatistics(discipline, institute) {
          const cachedData = localStorage.getItem(discipline);

          if (cachedData) {
            console.log(`Using cached data for discipline: ${discipline}`);
            return JSON.parse(cachedData);
          } else {
            let url;
            if (institute === "Факультет социального управления") {
              url = `https://script.google.com/macros/s/AKfycbxdL_UC__SmYJiPHmlsD4-T1ZiglPvgnehXed1OR9Qjk_fJ3rPxrVBT5Z0Zh1CiI7sC/exec?discipline=${encodeURIComponent(
                discipline
              )}`;
            } else {
              console.error(`Неизвестный факультет: ${institute}`);
              return null;
            }

            try {
              console.log(
                `Fetching data for discipline: ${discipline} from API: ${url}`
              );
              const response = await fetch(url);
              const data = await response.json();
              if (data.error) {
                console.error(
                  `API error for discipline ${discipline}: ${data.error}`
                );
                return null;
              }
              localStorage.setItem(discipline, JSON.stringify(data));
              return data;
            } catch (error) {
              console.error(
                `Fetching error for discipline ${discipline}:`,
                error
              );
              return null;
            }
          }
        }

        function formatDisciplineName(discipline) {
          return discipline.replace(/\s*\(.*?\)\s*/g, "").trim();
        }

        function countAndShowHiddenSubjects() {
          let hiddenSubjectsCount = 0;
          const hiddenSubjectsList = [];

          for (let key in localStorage) {
            if (key.startsWith("hiddenSubjects_")) {
              const hiddenSubjects = JSON.parse(localStorage.getItem(key));
              if (hiddenSubjects) {
                hiddenSubjectsCount += Object.keys(hiddenSubjects).length;
                hiddenSubjectsList.push(...Object.keys(hiddenSubjects));
              }
            }
          }

          console.log("Скрытые предметы:", hiddenSubjectsList);

          return hiddenSubjectsCount;
        }

        function countAndShowHiddenSubjects() {
          let hiddenSubjectsCount = 0;
          const hiddenSubjectsList = [];

          for (let key in localStorage) {
            if (key.startsWith("hiddenSubjects_")) {
              const hiddenSubjects = JSON.parse(localStorage.getItem(key));
              if (hiddenSubjects) {
                hiddenSubjectsCount += Object.keys(hiddenSubjects).length;
                hiddenSubjectsList.push(...Object.keys(hiddenSubjects));
              }
            }
          }

          console.log("Скрытые предметы:", hiddenSubjectsList);

          return hiddenSubjectsCount;
        }

        const copyLinkButton = document.getElementById("copy-link-button");

        copyLinkButton.addEventListener("click", () => {
          const institute = document
            .getElementById("institute-select")
            .value.replace(/ /g, "_");
          const group = document
            .getElementById("group-select")
            .value.replace(/ /g, "_");
          const url = `${window.location.origin}${window.location.pathname}?institute=${institute}&group=${group}`;

          if (navigator.clipboard) {
            navigator.clipboard
              .writeText(url)
              .then(() => {
                ShowCopyNotification();
              })
              .catch((err) => {
                showCustomNotification("Ошибка копирования ссылки через Clipboard API: " + err, "error");
              });
          } else {
            const textarea = document.createElement("textarea");
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              const successful = document.execCommand("copy");
              if (successful) {
                ShowCopyNotification();
              } else {
                showCustomNotification("Не удалось скопировать ссылку. Попробуйте обновить страницу.", "error");
              }
            } catch (err) {
              showCustomNotification("Ошибка копирования с использованием execCommand: " + err, "error");
            }
            document.body.removeChild(textarea);
          }
        });

        function ShowCopyNotification() {
          const existingNotification = document.querySelector(".notification");
          if (existingNotification) {
            existingNotification.remove();
          }

          const notification = document.createElement("div");
          notification.className =
            "fixed bottom-5 right-5 left-5 sm:right-10 sm:left-auto bg-green-500 text-white py-2 px-4 rounded-lg z-50 notification";
          notification.textContent = `Ссылка на расписание успешно скопирована!`;

          document.body.appendChild(notification);

          notification.addEventListener("touchmove", (e) => {
            e.preventDefault();
          });

          let touchStartX = 0;
          let currentX = 0;
          let moveX = 0;
          let isSwiping = false;

          notification.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
            isSwiping = true;
            notification.style.transition = "";
          });

          notification.addEventListener("touchmove", (e) => {
            if (!isSwiping) return;

            currentX = e.changedTouches[0].screenX;
            moveX = currentX - touchStartX;

            notification.style.transform = `translateX(${moveX}px)`;
          });

          notification.addEventListener("touchend", () => {
            if (!isSwiping) return;

            isSwiping = false;
            if (Math.abs(moveX) > 100) {
              const direction = moveX < 0 ? "-110%" : "110%";
              notification.style.transition = "transform 0.5s ease";
              notification.style.transform = `translateX(${direction})`;

              setTimeout(() => {
                notification.remove();
              }, 500);
            } else {
              notification.style.transition = "transform 0.3s ease";
              notification.style.transform = "translateX(0)";
            }
          });

          notification.addEventListener("click", () => {
            notification.style.transition =
              "transform 0.5s ease, opacity 0.5s ease";
            notification.style.transform = "translateX(100%)";
            notification.style.opacity = "0";

            setTimeout(() => {
              notification.remove();
            }, 500);
          });

          setTimeout(() => {
            notification.classList.add("show");
          }, 10);

          setTimeout(() => {
            notification.classList.remove("show");
            notification.classList.add("hide");

            setTimeout(() => {
              notification.remove();
            }, 500);
          }, 5000);
        }

        function showNotification(hiddenCount) {
          const notification = document.createElement("div");
          notification.className =
            "fixed bottom-5 right-5 left-5 sm:right-10 sm:left-auto bg-red-500 text-white py-2 px-4 rounded-lg z-50 notification";
          notification.textContent = `У вас есть скрытые предметы: ${hiddenCount}. Убедитесь, что ничего лишнего не скрыто! (посмотреть их можно под расписанием)`;

          document.body.appendChild(notification);

          notification.addEventListener("touchmove", (e) => {
            e.preventDefault();
          });

          let touchStartX = 0;
          let currentX = 0;
          let moveX = 0;
          let isSwiping = false;

          notification.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
            isSwiping = true;
            notification.style.transition = "";
          });

          notification.addEventListener("touchmove", (e) => {
            if (!isSwiping) return;

            currentX = e.changedTouches[0].screenX;
            moveX = currentX - touchStartX;

            notification.style.transform = `translateX(${moveX}px)`;
          });

          notification.addEventListener("touchend", () => {
            if (!isSwiping) return;

            isSwiping = false;
            if (Math.abs(moveX) > 100) {
              const direction = moveX < 0 ? "-110%" : "110%";
              notification.style.transition = "transform 0.5s ease";
              notification.style.transform = `translateX(${direction})`;

              setTimeout(() => {
                notification.remove();
              }, 500);
            } else {
              notification.style.transition = "transform 0.3s ease";
              notification.style.transform = "translateX(0)";
            }
          });

          notification.addEventListener("click", () => {
            notification.style.transition =
              "transform 0.5s ease, opacity 0.5s ease";
            notification.style.transform = "translateX(100%)";
            notification.style.opacity = "0";

            setTimeout(() => {
              notification.remove();
            }, 500);
          });

          setTimeout(() => {
            notification.classList.add("show");
          }, 10);

          setTimeout(() => {
            notification.classList.remove("show");
            notification.classList.add("hide");

            setTimeout(() => {
              notification.remove();
            }, 500);
          }, 5000);
        }

        const hiddenSubjectsCount = countAndShowHiddenSubjects();
        if (hiddenSubjectsCount > 0) {
          showNotification(hiddenSubjectsCount);
        }

        const calendarIcon = document.getElementById("calendarIcon");
        const modal = document.getElementById("warningModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const modalContent = modal.querySelector(".bg-gray-600");

        closeModalBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });

        modal.addEventListener("click", (event) => {
          if (!modalContent.contains(event.target)) {
            modal.classList.add("hidden");
          }
        });

        calendarIcon.addEventListener("click", () => {
          modal.classList.remove("hidden");
        });

        closeModalBtn.addEventListener("click", () => {
          modal.classList.add("hidden");
        });

        const targetDiv = document.querySelector(
          ".flex.justify-between.items-center.mt-4.w-full"
        );

        function toggleVisibility() {
          if (!instituteSelect.value || !groupSelect.value) {
            targetDiv.style.display = "none";
          } else {
            targetDiv.style.display = "flex";
          }
        }

        instituteSelect.addEventListener("change", toggleVisibility);
        groupSelect.addEventListener("change", toggleVisibility);

        toggleVisibility();

        mobileMenuButton.addEventListener('click', function () {
            triggerHapticFeedback('impact', 'light');
        });

        copyLinkButton?.addEventListener('click', (event) => {
            triggerHapticFeedback('impact', 'light');
        });

        document.getElementById('schedule-form')?.addEventListener('submit', async (event) => {
            triggerHapticFeedback('impact', 'medium');
        });

        document.getElementById('institute-select')?.addEventListener('change', () => {
            triggerHapticFeedback('selection');
        });

        document.getElementById('group-select')?.addEventListener('change', () => {
            triggerHapticFeedback('selection');
        });

        document.getElementById('betaBadge')?.addEventListener('click', () => {
            triggerHapticFeedback('impact', 'light');
        });

        document.getElementById('closeBetaExplanation')?.addEventListener('click', () => {
            triggerHapticFeedback('impact', 'light');
        });

        document.getElementById('closeViewModeExplanation')?.addEventListener('click', () => {
            triggerHapticFeedback('impact', 'light');
        });

        document.querySelectorAll('.bg-slate-800.rounded-lg.p-2.flex.items-center button').forEach(button => {
            button.addEventListener('click', () => {
                triggerHapticFeedback('impact', 'medium');
            });
        });

        document.querySelectorAll('.flex.justify-around.p-1.md\\:p-2.mb-4.md\\:mb-0 a').forEach(link => {
            link.addEventListener('click', () => {
                triggerHapticFeedback('impact', 'light');
            });
        });

        document.querySelectorAll('footer nav a').forEach(link => {
            link.addEventListener('click', () => {
                triggerHapticFeedback('impact', 'light');
            });
        });

        document.getElementById('viewToggle')?.addEventListener('change', () => {
            triggerHapticFeedback('selection');
        });

        document.querySelectorAll('.flex.justify-center.gap-2.overflow-x-auto button').forEach(button => {
            button.addEventListener('click', () => {
                triggerHapticFeedback('impact', 'light');
            });
        });

        document.querySelectorAll('.switch input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                triggerHapticFeedback('selection');
            });
        });

        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            node.querySelectorAll('.switch input[type="checkbox"]').forEach(checkbox => {
                                checkbox.addEventListener('change', () => {
                                    triggerHapticFeedback('selection');
                                });
                            });

                            node.querySelectorAll('.flex.justify-center.gap-2.overflow-x-auto button').forEach(button => {
                                button.addEventListener('click', () => {
                                    triggerHapticFeedback('impact', 'light');
                                });
                            });
                        }
                    });
                }
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    });

    const weekRanges = (() => {
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();

      function getFirstMondayOfMonth(year, month) {
        const date = new Date(year, month, 1);
        const day = date.getDay();
        const diff = day === 0 ? 6 : day - 1;

        if (month >= 8) {
          date.setDate(date.getDate() + (diff === 0 ? 1 : 8 - diff));
        } else {
          date.setDate(date.getDate() + (diff === 0 ? 0 : 7 - diff));
        }
        return date;
      }

      function generateWeeks(startDate) {
        const weeks = [];
        const start = new Date(startDate);

        for (let i = 0; i < 18; i++) {
          const weekStart = new Date(start);
          weekStart.setDate(start.getDate() + i * 7);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);

          const monthNames = ["января", "февраля", "марта", "апреля", "мая", "июня", "июля", "августа", "сентября", "октября", "ноября", "декабря"];

          weeks.push({
            start: weekStart.toISOString().split('T')[0],
            end: weekEnd.toISOString().split('T')[0],
            text: `${i + 1} - ${weekStart.getDate()} ${monthNames[weekStart.getMonth()]}`
          });
        }
        return weeks;
      }

      if (currentMonth >= 0 && currentMonth <= 5) {
        const springStart = getFirstMondayOfMonth(currentYear, 1);
        return generateWeeks(springStart);
      }
      else if (currentMonth >= 8 && currentMonth <= 11) {
        const autumnStart = getFirstMondayOfMonth(currentYear, 8);
        return generateWeeks(autumnStart);
      }
      else {
        const autumnStart = getFirstMondayOfMonth(currentYear, 8);
        return generateWeeks(autumnStart);
      }
    })();

    function getCurrentWeekMessage() {
      const today = new Date();
      const todayStr = today.toISOString().split("T")[0];
      const currentWeek = weekRanges.find(
        (range) => todayStr >= range.start && todayStr <= range.end
      );

      const day = today.getDate();
      const monthNames = [
        "января",
        "февраля",
        "марта",
        "апреля",
        "мая",
        "июня",
        "июля",
        "августа",
        "сентября",
        "октября",
        "ноября",
        "декабря",
      ];
      const currentDate = `${day} ${monthNames[today.getMonth()]}`;

      if (currentWeek) {
        const trimmedText = currentWeek.text.split(" ")[0];
        return `Сегодня ${currentDate}, ${trimmedText} неделя`;
      } else {
        return `Сегодня ${currentDate}, каникулы!`;
      }
    }

    document.getElementById("week-info").innerHTML = getCurrentWeekMessage();

    function updateWarningModal() {
      const warningMessage = document.getElementById("warningMessage");
      warningMessage.innerHTML = getCurrentWeekMessage();
    }

    updateWarningModal();

    function formatDate(isoDate) {
      const date = new Date(isoDate);
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      return `${day}.${month}.${year}`;
    }

    function getDayName(dayNumber) {
      const shortDays = [
        "Пн",
        "Вт",
        "Ср",
        "Чт",
        "Пт",
        "Сб",
        "Вс"
      ];
      return shortDays[dayNumber];
    }

    mobileMenuButton.addEventListener("click", function () {
      if (
        mobileMenu.classList.contains("hide") ||
        mobileMenu.classList.contains("hidden")
      ) {
        mobileMenu.classList.remove("hidden", "hide");
        mobileMenu.classList.add("show");
      } else {
        mobileMenu.classList.remove("show");
        mobileMenu.classList.add("hide");

        mobileMenu.addEventListener(
          "animationend",
          () => {
            if (mobileMenu.classList.contains("hide")) {
              mobileMenu.classList.add("hidden");
            }
          },
          { once: true }
        );
      }
    });

    document.addEventListener("click", function (event) {
      if (
        !mobileMenu.contains(event.target) &&
        !mobileMenuButton.contains(event.target)
      ) {
        mobileMenu.classList.remove("show");
        mobileMenu.classList.add("hide");

        mobileMenu.addEventListener(
          "animationend",
          () => {
            if (mobileMenu.classList.contains("hide")) {
              mobileMenu.classList.add("hidden");
            }
          },
          { once: true }
        );
      }
    });

    mobileMenu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", function () {
        mobileMenu.classList.remove("show");
        mobileMenu.classList.add("hide");

        mobileMenu.addEventListener(
          "animationend",
          () => {
            if (mobileMenu.classList.contains("hide")) {
              mobileMenu.classList.add("hidden");
            }
          },
          { once: true }
        );
      });
    });

    function toggleSubjectVisibility(
      group,
      subjectName,
      lessonType,
      teacherName,
      isVisible
    ) {
      let hiddenSubjects =
        JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};
      if (!isVisible) {
        if (!hiddenSubjects[subjectName]) {
          hiddenSubjects[subjectName] = [];
        }
        if (
          !hiddenSubjects[subjectName].some(
            (h) => h.type === lessonType && h.teacher === (teacherName || "")
          )
        ) {
          hiddenSubjects[subjectName].push({
            type: lessonType,
            teacher: teacherName || "",
          });
        }
        showHideNotification(subjectName, lessonType, teacherName);
      } else {
        if (hiddenSubjects[subjectName]) {
          hiddenSubjects[subjectName] = hiddenSubjects[subjectName].filter(
            (h) =>
              !(h.type === lessonType && h.teacher === (teacherName || ""))
          );
          if (hiddenSubjects[subjectName].length === 0) {
            delete hiddenSubjects[subjectName];
          }
        }
      }
      localStorage.setItem(
        `hiddenSubjects_${group}`,
        JSON.stringify(hiddenSubjects)
      );
      document
        .getElementById("schedule-form")
        .dispatchEvent(new Event("submit"));
    }

    const lessonTypes = {
      0: "none",
      2: "Лекция",
      4: "Практика",
      8: "Лабораторная работа",
      1: "Курсовой проект",
      5: "Консультация",
      6: "Лекция + Практика",
      7: "Дифференцированный зачет",
      3: "Экзамен",
      9: "Библиотека",
      10: "Лекция + Лабораторная работа",
      11: "Организационное собрание",
      12: "Не поддерживается",
    };

    function showHideNotification(subjectName, lessonType, teacherName) {
      const lessonTypeName = lessonTypes[lessonType] || "Неизвестный тип";

      const notification = document.createElement("div");
      notification.className =
        "fixed bottom-5 right-5 left-5 sm:right-10 sm:left-auto bg-blue-500 text-white py-2 px-4 rounded-lg z-50 notification";
      notification.textContent = `${lessonTypeName} "${subjectName}" ${teacherName ? " с " + teacherName : ""
        } теперь скрыта на протяжении всего семестра. Вы можете просмотреть скрытые предметы под расписанием.`;

      document.body.appendChild(notification);

      notification.addEventListener("touchmove", (e) => {
        e.preventDefault();
      });

      let touchStartX = 0;
      let currentX = 0;
      let moveX = 0;
      let isSwiping = false;

      notification.addEventListener("touchstart", (e) => {
        touchStartX = e.changedTouches[0].screenX;
        isSwiping = true;
        notification.style.transition = "";
      });

      notification.addEventListener("touchmove", (e) => {
        if (!isSwiping) return;

        currentX = e.changedTouches[0].screenX;
        moveX = currentX - touchStartX;

        notification.style.transform = `translateX(${moveX}px)`;
      });

      notification.addEventListener("touchend", () => {
        if (!isSwiping) return;

        isSwiping = false;
        if (Math.abs(moveX) > 100) {
          const direction = moveX < 0 ? "-110%" : "110%";
          notification.style.transition = "transform 0.5s ease";
          notification.style.transform = `translateX(${direction})`;

          setTimeout(() => {
            notification.remove();
          }, 500);
        } else {
          notification.style.transition = "transform 0.3s ease";
          notification.style.transform = "translateX(0)";
        }
      });

      notification.addEventListener("click", () => {
        notification.style.transition =
          "transform 0.5s ease, opacity 0.5s ease";
        notification.style.transform = "translateX(100%)";
        notification.style.opacity = "0";

        setTimeout(() => {
          notification.remove();
        }, 500);
      });

      setTimeout(() => {
        notification.classList.add("show");
      }, 10);

      setTimeout(() => {
        notification.classList.remove("show");
        notification.classList.add("hide");

        setTimeout(() => {
          notification.remove();
        }, 500);
      }, 10000);
    }

    function updateHiddenSubjectsSection(group) {
      const hiddenSubjectsSection = document.getElementById(
        "hidden-subjects-section"
      );
      const hiddenSubjectsContainer =
        document.getElementById("hidden-subjects");
      const hiddenSubjects =
        JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};

      const lessonTypes = {
        0: "none",
        2: "Лекция",
        4: "Практика",
        8: "Лабораторная работа",
        1: "Курсовой проект",
        5: "Консультация",
        6: "Лекция + Практика",
        7: "Дифференцированный зачет",
        3: "Экзамен",
        9: "Библиотека",
        10: "Лекция + Лабораторная работа",
        11: "Организационное собрание",
        12: "Не поддерживается",
      };

      hiddenSubjectsContainer.innerHTML = "";
      for (let subject in hiddenSubjects) {
        hiddenSubjects[subject].forEach((item) => {
          const subjectElement = document.createElement("div");
          subjectElement.className =
            "bg-slate-800 p-4 rounded-lg mb-2 flex justify-between items-center";
          subjectElement.innerHTML = `
                        <p class="text-lg font-bold text-white">${subject} (${lessonTypes[item.type]
            }, ${item.teacher})</p>
                        <label class="switch">
                            <input type="checkbox" onchange="showSubject('${group}', '${subject}', ${item.type
            }, '${item.teacher}')">
                            <span class="slider round"></span>
                        </label>
                    `;
          hiddenSubjectsContainer.appendChild(subjectElement);
        });
      }

      if (Object.keys(hiddenSubjects).length > 0) {
        hiddenSubjectsSection.classList.remove("hidden");
      } else {
        hiddenSubjectsSection.classList.add("hidden");
      }
    }

    function showSubject(group, subjectName, lessonType, teacherName) {
      let hiddenSubjects =
        JSON.parse(localStorage.getItem(`hiddenSubjects_${group}`)) || {};
      if (hiddenSubjects[subjectName]) {
        hiddenSubjects[subjectName] = hiddenSubjects[subjectName].filter(
          (h) => !(h.type === lessonType && h.teacher === teacherName)
        );
        if (hiddenSubjects[subjectName].length === 0) {
          delete hiddenSubjects[subjectName];
        }
      }
      localStorage.setItem(
        `hiddenSubjects_${group}`,
        JSON.stringify(hiddenSubjects)
      );
      document
        .getElementById("schedule-form")
        .dispatchEvent(new Event("submit"));
    }

    async function getStatistics(discipline, institute) {
      const cachedData = localStorage.getItem(discipline);

      if (cachedData) {
        console.log(`Using cached data for discipline: ${discipline}`);
        return JSON.parse(cachedData);
      } else {
        let url;
        if (institute === "Факультет социального управления") {
          url = `https://script.google.com/macros/s/AKfycbxdL_UC__SmYJiPHmlsD4-T1ZiglPvgnehXed1OR9Qjk_fJ3rPxrVBT5Z0Zh1CiI7sC/exec?discipline=${encodeURIComponent(
            discipline
          )}`;
        } else {
          console.error(`Неизвестный факультет: ${institute}`);
          return null;
        }

        try {
          console.log(
            `Fetching data for discipline: ${discipline} from API: ${url}`
          );
          const response = await fetch(url);
          const data = await response.json();
          if (data.error) {
            console.error(
              `API error for discipline ${discipline}: ${data.error}`
            );
            return null;
          }
          localStorage.setItem(discipline, JSON.stringify(data));
          return data;
        } catch (error) {
          console.error(
            `Fetching error for discipline ${discipline}:`,
            error
          );
          return null;
        }
      }
    }

    function formatDisciplineName(discipline) {
      return discipline.replace(/\s*\(.*?\)\s*/g, "").trim();
    }

    function displaySchedule(data, course) {
      const scheduleContainer = document.getElementById("schedule");
      scheduleContainer.innerHTML = "";

      const shortDays = [
        "Пн",
        "Вт",
        "Ср",
        "Чт",
        "Пт",
        "Сб",
        "Вс"
      ];

      const days = [
        "Понедельник",
        "Вторник",
        "Среда",
        "Четверг",
        "Пятница",
        "Суббота",
        "Воскресенье"
      ];

      const groupSelect = document.getElementById("group-select");
      const selectedOption = groupSelect.options[groupSelect.selectedIndex];
      if (!selectedOption || !selectedOption.value) {
        const noDataElement = document.createElement("div");
        noDataElement.className = "text-center text-white text-xl p-4";
        noDataElement.innerText = "Выберите группу";
        scheduleContainer.appendChild(noDataElement);
        return;
      }

      const groupText = selectedOption.text;
      const groupNumber = groupText.split(" ")[0];

      console.log('Raw data received:', data);

      if (!Array.isArray(data.items)) {
        console.error('Expected data.items to be an array, got:', typeof data.items);
        const noDataElement = document.createElement("div");
        noDataElement.className = "text-center text-white text-xl p-4";
        noDataElement.innerText = "Ошибка формата данных расписания. Пожалуйста, обратитесь к администратору.";
        scheduleContainer.appendChild(noDataElement);
        return;
      }

      const courseData = data.items.filter(item => {
        const itemGroupNumber = item.courseInfo?.number;
        console.log('Comparing group numbers:', {
          itemGroupNumber,
          groupNumber,
          match: itemGroupNumber === groupNumber
        });
        return itemGroupNumber === groupNumber;
      });

      if (courseData.length === 0) {
        console.log('No data available:', {
          selectedGroup: groupText,
          groupNumber: groupNumber,
          availableGroups: data.items.map(item => item.courseInfo?.number).filter(Boolean)
        });

        const noDataElement = document.createElement("div");
        noDataElement.className = "text-center text-white text-xl p-4";
        noDataElement.innerHTML = `
                <p>Расписание для группы ${groupNumber} не найдено.</p>
                <p class="text-sm text-gray-400 mt-2">Пожалуйста, убедитесь, что вы выбрали правильную группу.</p>
            `;
        scheduleContainer.appendChild(noDataElement);
        return;
      }

      console.log('Found data for group:', courseData);

      const titleContainer = document.createElement("div");
      titleContainer.className = "flex justify-center md:items-center flex-col";

      const titleElement = document.createElement("h2");
      titleElement.className = "p-4 md:pr-20 md:pl-20 md:ml-20 md:mr-20 sm:ml-0 sm:mr-0 rounded-lg text-center text-xl lg:text-3xl md:text-xl font-bold text-white shadow-lg transition";
      titleElement.style.background = "radial-gradient(circle, rgba(17, 51, 107, 1) 10%, rgba(7, 24, 39, 1) 100%)";

      const groupInfo = courseData[0].courseInfo;
      const startDate = groupInfo.startDate ? ` (с ${groupInfo.startDate})` : '';
      titleElement.innerText = `Расписание группы ${groupNumber}`;

      if (groupInfo.startDate) {
        const dateInfo = document.createElement("p");
        dateInfo.className = "text-sm text-gray-400 mt-2";
        dateInfo.innerText = `Начало обучения с ${groupInfo.startDate}`;
        titleElement.appendChild(dateInfo);
      }

      titleContainer.appendChild(titleElement);
      scheduleContainer.appendChild(titleContainer);

      const viewModeContainer = document.createElement("div");
      viewModeContainer.className = "flex justify-center items-center";

      const viewModeSelector = document.createElement("div");
      viewModeSelector.className = "bg-slate-800 rounded-lg p-2 flex items-center";

      const allModeBtn = document.createElement("button");
      allModeBtn.className = "px-4 py-2 rounded-lg mr-2 transition-all";
      allModeBtn.textContent = window.innerWidth <= 768 ? "Общее" : "Общее расписание";

      const actualModeBtn = document.createElement("button");
      actualModeBtn.className = "px-4 py-2 rounded-lg transition-all";
      actualModeBtn.textContent = window.innerWidth <= 768 ? "По дате" : "Актуальное по дате";

      const helpIcon = document.createElement("div");
      helpIcon.className = "ml-2 bg-blue-600 w-6 h-6 rounded-full flex justify-center items-center cursor-pointer";
      helpIcon.innerHTML = `<span class="text-white font-bold">?</span>`;
      helpIcon.title = "Информация о режимах просмотра";
      helpIcon.onclick = () => {
        triggerHapticFeedback('impact', 'medium');
        document.getElementById('viewModeExplanationModal').classList.remove('translate-y-full');
      };

      const viewMode = localStorage.getItem("scheduleViewMode") || "all";
      if (viewMode === "all") {
        allModeBtn.classList.add("bg-blue-700", "text-white");
        actualModeBtn.classList.add("bg-gray-700", "text-gray-400");
      } else {
        actualModeBtn.classList.add("bg-blue-700", "text-white");
        allModeBtn.classList.add("bg-gray-700", "text-gray-400");
      }

      allModeBtn.addEventListener("click", () => {
        localStorage.setItem("scheduleViewMode", "all");
        triggerHapticFeedback('impact', 'medium');
        displaySchedule(data, course);
      });

      actualModeBtn.addEventListener("click", () => {
        localStorage.setItem("scheduleViewMode", "actual");
        triggerHapticFeedback('impact', 'medium');
        displaySchedule(data, course);
      });

      viewModeSelector.appendChild(allModeBtn);
      viewModeSelector.appendChild(actualModeBtn);
      viewModeSelector.appendChild(helpIcon);
      viewModeContainer.appendChild(viewModeSelector);
      scheduleContainer.appendChild(viewModeContainer);

      const hiddenSubjects = JSON.parse(localStorage.getItem(`hiddenSubjects_${course}`)) || {};

      function isLessonInDate(lesson) {
        if (!lesson.startDate && !lesson.endDate) return true;

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        if (lesson.startDate && lesson.endDate) {
          const startParts = lesson.startDate.split('.');
          const endParts = lesson.endDate.split('.');
          const startDate = new Date(`${startParts[2]}-${startParts[1]}-${startParts[0]}`);
          const endDate = new Date(`${endParts[2]}-${endParts[1]}-${endParts[0]}`);

          return today >= startDate && today <= endDate;
        } else if (lesson.startDate) {
          const startParts = lesson.startDate.split('.');
          const startDate = new Date(`${startParts[2]}-${startParts[1]}-${startParts[0]}`);

          return today >= startDate;
        } else if (lesson.endDate) {
          const endParts = lesson.endDate.split('.');
          const endDate = new Date(`${endParts[2]}-${endParts[1]}-${endParts[0]}`);

          return today <= endDate;
        }

        return true;
      }

      function displayDaySchedule(dayIndex) {
        const viewMode = localStorage.getItem("scheduleViewMode") || "all";
        const dayElement = document.createElement("div");
        dayElement.className = "p-4 bg-slate-900 rounded-lg mb-4 day-schedule";

        const currentDate = new Date();
        const isSpring = currentDate.getMonth() >= 0 && currentDate.getMonth() <= 5;
        const isAutumn = currentDate.getMonth() >= 8 && currentDate.getMonth() <= 11;

        const springYear = isSpring ? currentDate.getFullYear() : currentDate.getFullYear() + 1;
        const autumnYear = isAutumn ? currentDate.getFullYear() : currentDate.getFullYear() - 1;

        const dayLessons = courseData.filter(item => {
          const lessonDate = new Date(item.days[0].info.date);

          if (isSpring) {
            if (lessonDate.getFullYear() !== springYear ||
              lessonDate.getMonth() > 5 ||
              lessonDate.getMonth() < 0) {
              return false;
            }
          } else if (isAutumn) {
            if (lessonDate.getFullYear() !== autumnYear ||
              lessonDate.getMonth() < 8 ||
              lessonDate.getMonth() > 11) {
              return false;
            }
          } else {
            if (currentDate.getMonth() >= 6 && currentDate.getMonth() <= 7) {
              if (lessonDate.getFullYear() !== currentDate.getFullYear() ||
                lessonDate.getMonth() < 8 ||
                lessonDate.getMonth() > 11) {
                return false;
              }
            }
          }

          return item.days[0].info.type === dayIndex;
        });

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (dayLessons.length === 0) {
          return null;
        }

        let hasVisibleLessons = false;

        dayLessons.forEach(item => {
          const lessonDate = new Date(item.days[0].info.date);
          const isToday = lessonDate.getTime() === today.getTime();

          if (isToday) {
            dayElement.classList.add('border-2', 'border-blue-500');
          }

          const formattedDate = formatDate(item.days[0].info.date);
          const dayInfo = document.createElement("h3");
          dayInfo.className = "text-2xl font-semibold text-white mb-2";
          dayInfo.innerText = `${days[dayIndex]}`;

          if (!dayElement.querySelector('h3')) {
            dayElement.appendChild(dayInfo);
          }

          let lessonsAfterFilter = [];

          if (viewMode === "actual") {
            lessonsAfterFilter = item.days[0].lessons.filter(lesson => isLessonInDate(lesson));
          } else {
            lessonsAfterFilter = item.days[0].lessons;
          }

          if (lessonsAfterFilter.length === 0 && viewMode === "actual") {
            return;
          }

          lessonsAfterFilter.forEach(lesson => {
            const isHidden = hiddenSubjects[lesson.lessonName] &&
              hiddenSubjects[lesson.lessonName].some(h =>
                h.type === lesson.type || (h.teacher === (lesson.teacherName || "")));

            if (isHidden) return;

            hasVisibleLessons = true;

            const lessonContainer = document.createElement("div");
            const lessonTypeColors = {
              lecture: 'border-blue-400',
              practice: 'border-yellow-500',
              other: 'border-white-500'
            };
            lessonContainer.className = "bg-slate-800 p-4 rounded-lg mb-2 flex relative";

            if (lesson.additionalSlots && lesson.additionalSlots.length > 0) {
              lessonContainer.classList.add('multi-lesson');

              const timelineContainer = document.createElement("div");
              timelineContainer.className = `flex flex-col items-end justify-between border-r-2 ${lessonTypeColors[lesson.type] || 'border-slate-300'} pr-2 w-14 mr-2`;

              const startTime = document.createElement("div");
              startTime.className = "text-sm font-bold";
              startTime.textContent = lesson.startAt;
              timelineContainer.appendChild(startTime);

              const timeline = document.createElement("div");
              timeline.className = "w-0.5 flex-grow my-1";
              timelineContainer.appendChild(timeline);

              const lastSlot = lesson.additionalSlots[lesson.additionalSlots.length - 1];
              const endTime = document.createElement("div");
              endTime.className = "text-sm font-bold";
              endTime.textContent = lastSlot.endAt;
              timelineContainer.appendChild(endTime);

              lessonContainer.appendChild(timelineContainer);

              const multiLessonIndicator = document.createElement("div");
              multiLessonIndicator.className = "absolute -left-2 top-1/2 transform -translate-y-1/2 w-1 h-4/5 bg-blue-400 rounded-full";
              lessonContainer.appendChild(multiLessonIndicator);
            } else {
              const timeContainer = document.createElement("div");
              timeContainer.className = `flex flex-col items-end justify-between border-r-2 ${lessonTypeColors[lesson.type] || 'border-slate-300'} pr-2 w-14 mr-2`;

              if (lesson.startAt && lesson.endAt) {
                timeContainer.innerHTML = `
                                <span class="text-sm font-bold">${lesson.startAt}</span>
                                <span class="text-sm font-bold">${lesson.endAt}</span>
                            `;
              }
              lessonContainer.appendChild(timeContainer);
            }

            const lessonInfo = document.createElement("div");
            lessonInfo.className = "flex-grow";

            const typeClasses = {
              lecture: 'text-blue-400',
              practice: 'text-yellow-500',
              other: 'text-white-500'
            };

            const typeTexts = {
              lecture: 'Лекция',
              practice: 'Практика',
              other: 'Другое'
            };

            const typeClass = typeClasses[lesson.type] || 'text-slate-400';
            const typeText = typeTexts[lesson.type] || 'Занятие';

            const periodInfo = lesson.startDate && lesson.endDate
              ? `с ${lesson.startDate} по ${lesson.endDate}`
              : lesson.startDate
                ? `с ${lesson.startDate}`
                : '';

            const durationText = lesson.additionalSlots && lesson.additionalSlots.length > 0
              ? `Занятие на ${lesson.additionalSlots.length + 1} пары`
              : '';

            lessonInfo.innerHTML = `
                        <p class="lg:text:md md:text-md sm:text:sm font-bold text-white">${lesson.lessonName}</p>
                        <p class="text-sm ${typeClass}">${typeText}</p>
                        ${durationText ? `<p class="text-sm text-blue-400">${durationText}</p>` : ''}
                        <p class="text-sm text-slate-400">${lesson.teacherName || "Преподаватель не указан"}</p>
                        <p class="text-sm text-slate-400">${lesson.auditoryName ? "Аудитория: " + lesson.auditoryName : "Аудитория не указана"}</p>
                        ${periodInfo ? `<p class="text-sm text-slate-400">${periodInfo}</p>` : ''}
                        ${lesson.isDistant ? '<p class="text-sm text-red-400">Дистанционно</p>' : ''}
                    `;

            lessonContainer.appendChild(lessonInfo);
            dayElement.appendChild(lessonContainer);
          });
        });

        return hasVisibleLessons ? dayElement : null;
      }

      const isMobileView = window.innerWidth <= 768;
      if (isMobileView) {
        const toggleContainer = document.createElement("div");
        toggleContainer.className = "flex justify-end items-center -mt-2 mb-2";

        const toggleLabel = document.createElement("label");
        toggleLabel.className = "switch flex items-center";
        toggleLabel.innerHTML = `<input type="checkbox" id="viewToggle">
            <span class="slider round"></span>`;

        const leftText = document.createElement("span");
        leftText.className = "mr-2 text-white";
        leftText.textContent = "По дням";

        const rightText = document.createElement("span");
        rightText.className = "ml-2 text-white";
        rightText.textContent = "На неделю";

        toggleContainer.appendChild(leftText);
        toggleContainer.appendChild(toggleLabel);
        toggleContainer.appendChild(rightText);
        scheduleContainer.appendChild(toggleContainer);

        const isFullView = localStorage.getItem("isFullView") === "true";
        document.getElementById("viewToggle").checked = isFullView;

        viewToggle.addEventListener("change", function () {
          const isChecked = this.checked;
          localStorage.setItem("isFullView", isChecked);
          scheduleContainer.classList.add("transition-opacity", "duration-500");
          scheduleContainer.classList.add("opacity-0");
          setTimeout(() => {
            displaySchedule(data, course);
            scheduleContainer.classList.remove("opacity-0");
            scheduleContainer.classList.add("opacity-100");
            setTimeout(() => {
              scheduleContainer.classList.remove("transition-opacity", "duration-500", "opacity-100");
            }, 500);
          }, 500);
        });
      }

      if (isMobileView && document.getElementById("viewToggle").checked) {
        const weekContainer = document.createElement("div");
        weekContainer.className = "grid grid-cols-1 gap-4";
        let hasAnyLessons = false;
        days.forEach((_, index) => {
          const dayElement = displayDaySchedule(index);
          if (dayElement) {
            hasAnyLessons = true;
            weekContainer.appendChild(dayElement);
          }
        });
        if (!hasAnyLessons) {
          const noLessonsMessage = document.createElement("div");
          noLessonsMessage.className = "text-center text-white text-xl p-4";
          noLessonsMessage.innerText = "На этой неделе нет занятий";
          weekContainer.appendChild(noLessonsMessage);
        }
        scheduleContainer.appendChild(weekContainer);
      } else if (isMobileView) {
        const daysContainer = document.createElement('div');
        daysContainer.className = 'flex justify-center gap-2 overflow-x-auto p-0 md:p-2';

        const scheduleView = document.createElement('div');
        scheduleView.className = 'day-schedule-container';

        const today = new Date();
        const currentDayIndex = today.getDay() - 1;
        const lastSelectedDayIndex = parseInt(localStorage.getItem('lastYspuSelectedDayIndex')) || currentDayIndex;

        const daysWithLessons = [];
        for (let i = 0; i < 7; i++) {
          daysWithLessons[i] = displayDaySchedule(i) !== null;
        }

        let hasAnyDays = false;

        days.forEach((dayName, index) => {
          if (!daysWithLessons[index]) return;

          hasAnyDays = true;
          const dayButton = document.createElement('button');
          dayButton.className = 'flex flex-col items-center p-4 rounded-lg bg-gray-700 text-white transition-all min-w-[70px]';
          dayButton.style.width = '70px';

          if (index === currentDayIndex) {
            dayButton.classList.add('border-2', 'border-blue-300');
          }

          if (index === lastSelectedDayIndex) {
            dayButton.classList.add('bg-blue-600');
          }

          dayButton.innerHTML = `<span class="text-sm">${shortDays[index]}</span>`;

          dayButton.onclick = () => {
            [...daysContainer.children].forEach(btn => btn.classList.remove('bg-blue-600'));
            dayButton.classList.add('bg-blue-600');

            const existingSchedule = scheduleView.querySelector('.day-schedule');
            if (existingSchedule) {
              existingSchedule.remove();
            }

            const dayElement = displayDaySchedule(index);
            if (dayElement) {
              scheduleView.appendChild(dayElement);
            } else {
              const noLessonsElement = document.createElement('div');
              noLessonsElement.className = 'p-4 bg-slate-900 rounded-lg mb-4 day-schedule';
              noLessonsElement.innerHTML = `
                            <h3 class="text-2xl font-semibold text-white mb-2">${days[index]}</h3>
                            <p class="text-center text-white">Нет занятий</p>
                        `;
              scheduleView.appendChild(noLessonsElement);
            }

            localStorage.setItem('lastYspuSelectedDayIndex', index.toString());
          };

          daysContainer.appendChild(dayButton);
        });

        if (!hasAnyDays) {
          const noLessonsMessage = document.createElement("div");
          noLessonsMessage.className = "text-center text-white text-xl p-4";
          noLessonsMessage.innerText = "На этой неделе нет занятий";
          scheduleContainer.appendChild(noLessonsMessage);
          return;
        }

        scheduleContainer.appendChild(daysContainer);
        scheduleContainer.appendChild(scheduleView);

        const validDayIndex = daysWithLessons[lastSelectedDayIndex] ? lastSelectedDayIndex :
          daysWithLessons.findIndex(hasLessons => hasLessons);

        if (validDayIndex >= 0) {
          const dayElement = displayDaySchedule(validDayIndex);
          if (dayElement) {
            scheduleView.appendChild(dayElement);

            const buttons = daysContainer.querySelectorAll('button');
            buttons.forEach((btn, idx) => {
              if (idx === validDayIndex - daysWithLessons.slice(0, validDayIndex)
                .filter(d => !d).length) {
                btn.classList.add('bg-blue-600');
              }
            });
          }
        }
      } else {
        const weekContainer = document.createElement("div");
        weekContainer.className = "grid grid-cols-1 gap-4";
        let hasAnyLessons = false;
        days.forEach((_, index) => {
          const dayElement = displayDaySchedule(index);
          if (dayElement) {
            hasAnyLessons = true;
            weekContainer.appendChild(dayElement);
          }
        });
        if (!hasAnyLessons) {
          const noLessonsMessage = document.createElement("div");
          noLessonsMessage.className = "text-center text-white text-xl p-4";
          noLessonsMessage.innerText = "На этой неделе нет занятий";
          weekContainer.appendChild(noLessonsMessage);
        }
        scheduleContainer.appendChild(weekContainer);
      }

      updateHiddenSubjectsSection(course);
    }

    window.onload = () => {
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then((registration) => {
            console.log(
              "Service Worker зарегистрирован с областью охвата:",
              registration.scope
            );
          })
          .catch((error) => {
            console.log("Ошибка регистрации Service Worker:", error);
          });
      }
    };

    document.addEventListener("DOMContentLoaded", function () {
      const betaBadge = document.getElementById("betaBadge");
      const betaExplanationModal = document.getElementById("betaExplanationModal");
      const closeBetaExplanationBtn = document.getElementById("closeBetaExplanation");
      const viewModeExplanationModal = document.getElementById("viewModeExplanationModal");
      const closeViewModeExplanationBtn = document.getElementById("closeViewModeExplanation");
      let isBetaModalOpen = false;
      let isViewModeModalOpen = false;

      function openBetaExplanation() {
        betaExplanationModal.classList.remove("translate-y-full");
        isBetaModalOpen = true;
        document.body.style.overflow = "hidden";
      }

      function closeBetaExplanation() {
        betaExplanationModal.classList.add("translate-y-full");
        isBetaModalOpen = false;
        document.body.style.overflow = "";
        localStorage.setItem('betaModalShown', 'true');
      }

      function openViewModeExplanation() {
        viewModeExplanationModal.classList.remove("translate-y-full");
        isViewModeModalOpen = true;
        document.body.style.overflow = "hidden";
      }

      function closeViewModeExplanation() {
        viewModeExplanationModal.classList.add("translate-y-full");
        isViewModeModalOpen = false;
        document.body.style.overflow = "";
      }

      betaBadge.addEventListener("click", openBetaExplanation);
      closeBetaExplanationBtn.addEventListener("click", closeBetaExplanation);
      closeViewModeExplanationBtn.addEventListener("click", closeViewModeExplanation);

      document.addEventListener("click", (e) => {
        if (isBetaModalOpen && !betaExplanationModal.contains(e.target) && e.target !== betaBadge) {
          closeBetaExplanation();
        }
        if (isViewModeModalOpen && !viewModeExplanationModal.contains(e.target)) {
          closeViewModeExplanation();
        }
      });

      const betaModalShown = localStorage.getItem('betaModalShown');
      if (!betaModalShown) {
        setTimeout(() => {
          openBetaExplanation();
        }, 1000);
      }
    });

    function updateMetaTags(groupNumber, direction) {
        document.title = `Расписание группы ${groupNumber} ${direction} | ystuRASP`;

        const descriptionMeta = document.querySelector('meta[name="description"]');
        if (descriptionMeta) {
            descriptionMeta.setAttribute('content', `Актуальное расписание занятий группы ${groupNumber} ${direction} ЯГПУ. Удобный просмотр лекций, практик и лабораторных работ.`);
        }

        const keywordsMeta = document.querySelector('meta[name="keywords"]');
        if (keywordsMeta) {
            keywordsMeta.setAttribute('content', `расписание группы ${groupNumber}, ${groupNumber} ЯГПУ, расписание ${direction}, ЯГПУ расписание занятий, расписание пар ЯГПУ`);
        }

        const ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) {
            ogTitle.setAttribute('content', `Расписание группы ${groupNumber} ${direction} | ystuRASP`);
        }

        const ogDescription = document.querySelector('meta[property="og:description"]');
        if (ogDescription) {
            ogDescription.setAttribute('content', `Актуальное расписание занятий группы ${groupNumber} ${direction} ЯГПУ. Удобный просмотр лекций, практик и лабораторных работ.`);
        }

        const canonicalLink = document.querySelector('link[rel="canonical"]');
        if (!canonicalLink) {
            const link = document.createElement('link');
            link.rel = 'canonical';
            link.href = `${window.location.origin}${window.location.pathname}?group=${encodeURIComponent(groupNumber)}`;
            document.head.appendChild(link);
        } else {
            canonicalLink.href = `${window.location.origin}${window.location.pathname}?group=${encodeURIComponent(groupNumber)}`;
        }

        const mainHeading = document.querySelector('h1');
        if (!mainHeading) {
            const heading = document.createElement('h1');
            heading.className = 'sr-only';
            heading.textContent = `Расписание группы ${groupNumber} ${direction} ЯГПУ`;
            document.querySelector('main').insertBefore(heading, document.querySelector('main').firstChild);
        } else {
            mainHeading.textContent = `Расписание группы ${groupNumber} ${direction} ЯГПУ`;
        }
    }

    // ... existing code ...

    scheduleForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const groupNumber = groupSelect.value;
        const selectedOption = groupSelect.options[groupSelect.selectedIndex];
        const direction = selectedOption.text;

        if (!groupNumber) {
            return;
        }

        updateMetaTags(groupNumber, direction);

        // ... rest of the existing submit handler code ...
    });

    // ... existing code ...
  </script>

  <script>
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const database = firebase.database();
      console.log("Firebase успешно инициализирован");

      const userId = Math.random().toString(36).substr(2, 9);

      const connectedRef = database.ref('.info/connected');
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          console.log('Подключено к Firebase');
          const group = document.getElementById('group-select')?.value || '';
          updateUserStatus(true, group);
        } else {
          console.log('Отключено от Firebase');
        }
      });

      function updateUserStatus(online, group = '') {
        const userStatusRef = database.ref('/online/' + userId);

        const instituteSelect = document.getElementById('institute-select');
        const selectedInstitute = instituteSelect?.options[instituteSelect?.selectedIndex]?.text || '';
        const instituteText = selectedInstitute && selectedInstitute !== 'Выберите направление' ? selectedInstitute + ' - ' : '';

        if (online) {
          userStatusRef.set({
            online: true,
            group: group && group.trim() ? 'ЯГПУ ' + instituteText + group : 'Гость',
            timestamp: firebase.database.ServerValue.TIMESTAMP
          })
            .then(() => console.log('Статус онлайн установлен'))
            .catch(error => console.error('Ошибка установки статуса:', error));

          userStatusRef.onDisconnect().remove()
            .then(() => console.log('Установлен обработчик отключения'))
            .catch(error => console.error('Ошибка установки обработчика отключения:', error));
        } else {
          userStatusRef.remove()
            .then(() => console.log('Статус офлайн установлен'))
            .catch(error => console.error('Ошибка удаления статуса:', error));
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const groupSelect = document.getElementById('group-select');
        const selectedOption = groupSelect?.options[groupSelect?.selectedIndex];
        const groupText = selectedOption?.text || '';
        if (groupText) {
          updateUserStatus(true, groupText);
        }
      });

      document.getElementById('schedule-form').addEventListener('submit', (event) => {
        const groupSelect = document.getElementById('group-select');
        const selectedOption = groupSelect.options[groupSelect.selectedIndex];
        const groupText = selectedOption.text;
        updateUserStatus(true, groupText);
      });

      const onlineRef = database.ref('/online');
      onlineRef.on('value', (snapshot) => {
        const users = snapshot.val() || {};
        const count = Object.keys(users).length;

        const groupStats = {};
        Object.values(users).forEach(user => {
          if (user.group) {
            groupStats[user.group] = (groupStats[user.group] || 0) + 1;
          }
        });

        document.getElementById('online-count-desktop').textContent = count;
        document.getElementById('online-count-mobile').textContent = count;

        const groupInfo = 'Количество пользователей на сайте прямо сейчас\n' +
          Object.entries(groupStats)
            .map(([group, count]) => `${group}: ${count} чел.`)
            .join('\n');

        const desktopCounter = document.querySelector('.online-users-counter.desktop');
        const mobileCounter = document.querySelector('.online-users-counter.mobile');

        if (groupInfo) {
          desktopCounter.setAttribute('data-groups', groupInfo);
          mobileCounter.setAttribute('data-groups', groupInfo);
        }
      }, (error) => {
        console.error('Ошибка получения данных:', error);
      });

      window.addEventListener('beforeunload', () => {
        updateUserStatus(false);
      });

      setInterval(() => {
        const userStatusRef = database.ref('/online/' + userId);
        userStatusRef.get()
          .then((snapshot) => {
            if (!snapshot.exists()) {
              console.log('Восстановление соединения...');
              const group = document.getElementById('group-select').value;
              updateUserStatus(true, group);
            }
          })
          .catch(error => console.error('Ошибка проверки статуса:', error));
      }, 30000);

    } catch (error) {
      console.error('Ошибка инициализации Firebase:', error);
    }
  </script>
  <!-- Snow with weather -->

  <!-- Hotjar Tracking Code for Site -->
  <script>
    (function (h, o, t, j, a, r) {
      h.hj =
        h.hj ||
        function () {
          (h.hj.q = h.hj.q || []).push(arguments);
        };
      h._hjSettings = { hjid: 5151783, hjsv: 6 };
      a = o.getElementsByTagName("head")[0];
      r = o.createElement("script");
      r.async = 1;
      r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
      a.appendChild(r);
    })(window, document, "https://static.hotjar.com/c/hotjar-", ".js?sv=");
  </script>
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
    (function (m, e, t, r, i, k, a) {
      m[i] =
        m[i] ||
        function () {
          (m[i].a = m[i].a || []).push(arguments);
        };
      m[i].l = 1 * new Date();
      for (var j = 0; j < document.scripts.length; j++) {
        if (document.scripts[j].src === r) {
          return;
        }
      }
      (k = e.createElement(t)),
        (a = e.getElementsByTagName(t)[0]),
        (k.async = 1),
        (k.src = r),
        a.parentNode.insertBefore(k, a);
    })(
      window,
      document,
      "script",
      "https://mc.yandex.ru/metrika/tag.js",
      "ym"
    );

    ym(97705826, "init", {
      clickmap: true,
      trackLinks: true,
      accurateTrackBounce: true,
      webvisor: true,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/97705826" style="position: absolute; left: -9999px" alt="" />
    </div>
  </noscript>
  <!-- /Yandex.Metrika counter -->
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-0K2G90RDS0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-0K2G90RDS0");
  </script>
  <!-- Google tag (gtag.js) -->

  <!-- Rybbit -->
      <script
      src="https://app.rybbit.io/api/script.js"
      data-site-id="293"
      defer
    ></script>
  <!-- Rybbit -->
</body>

</html>